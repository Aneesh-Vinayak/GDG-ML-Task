!pip install yfinance prophet -q

import yfinance as yf
import pandas as pd
from prophet import Prophet
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_error, mean_squared_error
import numpy as np
import ipywidgets as widgets
from IPython.display import display, clear_output

TICKERS = ["AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "NVDA", "BTC-USD"]
BACK_YEARS = 2
FORECAST_DAYS = 7

def load_data(ticker):
    try:
        df = yf.download(ticker, period=f"{BACK_YEARS}y", interval="1d", progress=False)
        df.reset_index(inplace=True)
        
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)
            
        data = df[['Date', 'Close']].rename(columns={'Date': 'ds', 'Close': 'y'})
        data['ds'] = data['ds'].dt.tz_localize(None)
        return data
    except Exception as e:
        return None

plot_output = widgets.Output()

def update_plot(change):
    ticker = change['new']
    
    plot_output.clear_output(wait=True)
    
    with plot_output:
        print(f"Fetching data and training model for {ticker}...")
        data = load_data(ticker)
        
        if data is None or data.empty:
            print(f"Error: No data found for {ticker}")
            return

        train_size = len(data) - FORECAST_DAYS
        train_df = data.iloc[:train_size]
        test_df = data.iloc[train_size:]

        model = Prophet(daily_seasonality=True, yearly_seasonality=True)
        model.fit(train_df)

        future = model.make_future_dataframe(periods=FORECAST_DAYS * 2)
        forecast = model.predict(future)

        metric_df = forecast.set_index('ds')[['yhat']].join(test_df.set_index('ds')[['y']], how='inner')
        mae = mean_absolute_error(metric_df['y'], metric_df['yhat'])
        rmse = np.sqrt(mean_squared_error(metric_df['y'], metric_df['yhat']))

        clear_output(wait=True)

        print(f"ANALYSIS FOR: {ticker}")
        print(f"Accuracy (Last 7 Days): MAE: ${mae:.2f} | RMSE: ${rmse:.2f}")

        fig1 = model.plot(forecast, figsize=(12, 6))
        plt.title(f"{ticker} Forecast (Next 7 Days)", fontsize=16)
        plt.xlabel("Date")
        plt.ylabel("Price ($)")
        plt.grid(True, alpha=0.3)
        plt.show()

        print("\nTrend Components (Seasonality & Trend):")
        fig2 = model.plot_components(forecast, figsize=(12, 8))
        plt.show()

dropdown = widgets.Dropdown(
    options=TICKERS,
    description='Select Stock:',
    style={'description_width': 'initial'}
)

dropdown.observe(update_plot, names='value')

display(dropdown)
display(plot_output)

dropdown.value = TICKERS[0]
update_plot({'new': TICKERS[0]})
